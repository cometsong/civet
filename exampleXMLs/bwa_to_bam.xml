<?xml version="1.0"?>

<!--
	A tool to align two fastq files and produce a bam file using
	bwa
-->
<tool 
	name="BWA to BAM PE" 
	env_prefix="BWA.ALIGN"
	threads="8">
	<!--
		The process hands us two input fastq files, the reference and 
		the file spec for an output sorted bam file.  This tool also 
		produces a bam index, which by definition is alongside the 
		bam file,  and is not explicitly named.
	-->
	<description>
		This tool takes two fastq files and aligns them, producing a
		sorted, indexed BAM file.
	</description>

	<option name="fasta" id="in_3" />
	<option name="algorithm" command_text="-a" value="bwtsw" />

	<!--
		We wouldn't really run index as part of the pipeline, but
		would use pre-built indices. I think. It runs for hours.
	-->
	<command>bwa index {algorithm} {fasta}</command>

	<!--
		Question:  Should we be able to reference file ids directly
		in the command line, without having to specify them in an option?
	-->
	<tempfile id="sai_1" />
	<tempfile id="sai_2" />
	<option name="sai_1" id="sai_1" />
	<option name="sai_2" id="sai_2" />

	<option name="maxDiff" command_text="-n" value="4" />
	<option name="end1_fq" id="in_1" />
	<option name="end2_fq" id="in_2" />

	<!--
		Only options that need to be overridable via env variables
		or need to include filenames need to be listed in option tags.
		Options that are fixed (e.g., -t 8, below) can be encoded
		directly in the command line.
	-->
	<command>bwa aln {maxDiff} -t 8 {fasta} {end1_fq} > {sai_1}</command>
	<command>bwa aln {maxDiff} -t 8 {fasta} {end2_fq} > {sai_2}</command>

	<tempfile id="sam" />
	<option name="maxIns" command_text="-a" value="700" />
	<command stdout_id="sam">
		bwa sampe {maxIns} {fasta} {sai_1} {sai_2} {end1_fq} {end2_fq}
	</command>

	<tempfile id="unsorted_bam" />
	<command stdout_id="unsorted_bam">samtools view -bS {sam}</command>

	<!--
		EXTENSION NEEDED????
	    We may need some kind of filename manipulation code in here.
		samtools sort wants just the prefix of the bam filename. It
		appends ".bam".  I've always hated that design.
		
		The file_regex attribute is NOT in the spec.  I'm just trying
		it on for size.  Comments welcome. (And I know it is a sed
		command, not a real regex. So sue me. If we want to do this for
		real, we'll do regexps.)
	-->
	<option name="unsort_bam" id="unsorted_bam" />
	<option name="out_bam" id="out_1" file_regex="s/.bam//" />
	<command>samtools sort {unsorted} {out_bam}</command>
	<command>samtools index {out_bam}.bam</command>
</tool>
