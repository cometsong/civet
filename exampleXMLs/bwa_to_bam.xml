<?xml version="1.0"?>

<!--
	A tool to align two fastq files and produce a bam file using
	bwa
-->
<tool 
	name="BWA_to_BAM_PE" 
	tool_config_prefix="BWA.ALIGN"
	threads="8"
	walltime="6:15:34">
	<!--
		The process hands us two input fastq files, the reference and 
		the file spec for an output sorted bam file.  This tool also 
		produces a bam index, which by definition is alongside the 
		bam file,  and is not explicitly named.
	-->
	<description>
		This tool takes two fastq files and aligns them, producing a
		sorted, indexed BAM file.
	</description>


	<!--
	        This tool requires some modules loaded to run on the
                cluster.
	-->
	<module>bwa</module>
	<module>samtools/0.1.16</module>

	<!--
	        Defile some options and their values for bwa.
	-->
	<option name="algorithm" command_text="-a" value="bwtsw" />

	<!--
		We wouldn't really run index as part of the pipeline, but
		would use pre-built indices. I think. It runs for hours.
	-->
	<command program="bwa">index {algorithm} {in_3}</command>

	<tempfile id="sai_1" />
	<tempfile id="sai_2" />

	<option name="maxDiff" command_text="-n" value="4" />

	<!--
		Only options that need to be overridable via env variables
		or need to include filenames need to be listed in option tags.
		Options that are fixed (e.g., -t 8, below) can be encoded
		directly in the command line.
	-->
	<command program="bwa" stdout_id = "sai_1"> aln {maxDiff} -t 8 {in_3} {in_1}</command>
	<command program="bwa" stdout_id = "sai_2"> aln {maxDiff} -t 8 {in_3} {in_2}</command>

	<tempfile id="sam" />
	<option name="maxIns" command_text="-a" value="700" />
	<command stdout_id="sam" program="bwa">
        sampe {maxIns} {in_3} {sai_1} {sai_2} {in_1} {in_2}
	</command>

	<tempfile id="unsorted_bam" />
	<command stdout_id="unsorted_bam" program="samtools">view -bS {sam}</command>

	<!--
		EXTENSION NEEDED????
	    We may need some kind of filename manipulation code in here.
		samtools sort wants just the prefix of the bam filename. It
		appends ".bam".  I've always hated that design.
		
		The file_regex attribute is NOT in the spec.  I'm just trying
		it on for size.  Comments welcome. (And I know it is a sed
		command, not a real regex. So sue me. If we want to do this for
		real, we'll do regexps.)
		
		Have to figure out how to link this in, now that we reference
		files directly in the command, and don't have an option involved.
	-->
	<!--<option name="out_bam" id="out_1" file_regex="s/.bam//" />-->
	<command program="samtools">sort {unsorted_bam} {out_1}</command>
	<command program="samtools">index {out_1}.bam</command>
</tool>
